<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot mit Gemini</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
    }
    #chatbox {
      width: 100%;
      height: 400px;
      overflow-y: scroll;
      border: 1px solid #fff;
      padding: 10px;
      background-color: #000;
      color: #fff;
    }
    #onAir {
      color: red;
      font-size: 1.5em;
      display: none;
    }
    #recordButton {
      margin-top: 10px;
      padding: 10px;
      background-color: green;
      color: white;
      border: none;
      cursor: pointer;
    }
    #recordButton.stop {
      background-color: red;
    }
    #browserMessages {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #fff;
      background-color: #000;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="onAir">On Air</div>
  <div id="chatbox"></div>
  <button id="recordButton">Verbindung starten</button>
  <div id="browserMessages"></div>
  <script src="https://cdn.jsdelivr.net/npm/webaudiorecorder@latest/dist/WebAudioRecorder.min.js"></script>
  <script>
    const APP_ID = 'acP7SyEGEm8ge7GkW1h9DStkqe6gQRfy2XIlDkST';
    const REST_API_KEY = 'u74saAzlTt9vic4uL34twMnouLCeoy1AgKlmXwqZ';
    
    let recorder;
    const recordButton = document.getElementById('recordButton');
    const chatbox = document.getElementById('chatbox');
    const onAir = document.getElementById('onAir');
    const browserMessages = document.getElementById('browserMessages');

    recordButton.addEventListener('click', () => {
      if (!recorder) {
        startRecording();
      } else {
        stopRecording();
      }
    });

    // Audioaufnahme starten
    function startRecording() {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          const audioContext = new AudioContext();
          const input = audioContext.createMediaStreamSource(stream);
          recorder = new WebAudioRecorder(input, {
            workerDir: 'https://cdn.jsdelivr.net/npm/webaudiorecorder@latest/dist/',
            encoding: 'wav',
            numChannels: 1,
            onEncoderLoading: function(recorder, encoding) {
              browserMessages.innerHTML += `<p>Lade Encoder für ${encoding}...</p>`;
            },
            onEncoderLoaded: function(recorder, encoding) {
              browserMessages.innerHTML += `<p>Encoder für ${encoding} geladen.</p>`;
            }
          });
          recorder.onComplete = function(recorder, blob) {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
              const base64Audio = reader.result.split(',')[1]; // Nur Base64-Daten
              sendAudioToBackend(base64Audio);
            };
          };
          recorder.startRecording();
          recordButton.textContent = 'Verbindung stoppen';
          recordButton.classList.add('stop');
          onAir.style.display = 'block';
        })
        .catch(err => {
          console.error('Mikrofonzugriff fehlgeschlagen:', err);
          browserMessages.innerHTML += `<p>Fehler: Mikrofonzugriff fehlgeschlagen - ${err.message}</p>`;
        });
    }

    // Audioaufnahme stoppen
    function stopRecording() {
      recorder.finishRecording();
      recordButton.textContent = 'Verbindung starten';
      recordButton.classList.remove('stop');
      onAir.style.display = 'none';
      recorder = null;
    }

    // Audio an Backend senden
    async function sendAudioToBackend(base64Audio) {
      try {
        const response = await fetch('https://parseapi.back4app.com/functions/processAudio', {
          method: 'POST',
          headers: {
            'X-Parse-Application-Id': APP_ID,
            'X-Parse-REST-API-Key': REST_API_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ audio: base64Audio })
        });
        const data = await response.json();
        const botResponse = data.result; // Ergebnis der Cloud-Funktion
        chatbox.innerHTML += `<p>Bot: ${botResponse}</p>`;
        speak(botResponse); // Text-to-Speech
      } catch (error) {
        console.error('Fehler beim Senden:', error);
        browserMessages.innerHTML += `<p>Fehler: ${error.message}</p>`;
      }
    }

    // Text-to-Speech mit Web Speech API
    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'de-DE'; // Deutsche Sprache
      window.speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
